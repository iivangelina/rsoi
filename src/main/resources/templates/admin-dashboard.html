<!DOCTYPE html>
<html lang="ru"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="https://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <title>–ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ | HR</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <style>
        :root {
            --bg: radial-gradient(circle at 10% 0%, #0f172a 0%, #020617 55%, #000 100%);
            --panel: rgba(15,23,42,.45);
            --card: rgba(15,23,42,.35);
            --accent: #38bdf8;
            --danger: #f43f5e;
        }
        body {
            margin: 0;
            min-height: 100vh;
            background: var(--bg);
            color: #e2e8f0;
            font-family: -apple-system, BlinkMacSystemFont,"Segoe UI",Roboto,Ubuntu,sans-serif;
            font-size: 15px;
        }
        .topbar {
            background: rgba(2,6,23,.35);
            border-bottom: 1px solid rgba(255,255,255,.04);
            padding: 14px 18px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .brand { font-weight: 700; font-size: 1.1rem; }
        .main { display: flex; min-height: calc(100vh - 56px); }
        .sidebar {
            width: 240px;
            background: rgba(2,6,23,.15);
            border-right: 1px solid rgba(255,255,255,.02);
            padding: 18px 14px 16px;
        }
        .sidebar-title {
            font-size: .78rem;
            text-transform: uppercase;
            color: #94a3b8;
            margin: 10px 0 6px;
            letter-spacing: .03em;
        }
        .menu a {
            display: block;
            color: #e2e8f0;
            text-decoration: none;
            padding: 8px 10px;
            border-radius: 10px;
            font-size: .9rem;
            margin-bottom: 5px;
            transition: .12s;
        }
        .menu a:hover,
        .menu a.active { background: rgba(148,163,184,.12); }

        .content {
            flex: 1;
            padding: 20px 24px 24px;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        .title-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
        }
        h1 { font-size: 1.45rem; margin: 0; }
        .subtitle { color: #94a3b8; font-size: .9rem; margin-top: 3px; }

        .btn-primary {
            background: linear-gradient(90deg, #38bdf8, #0ea5e9);
            border: none;
            border-radius: 999px;
            color: #fff;
            padding: 8px 16px 9px;
            font-weight: 600;
            font-size: .82rem;
            cursor: pointer;
        }
        .btn-secondary {
            background: rgba(15,23,42,.4);
            border: 1px solid rgba(148,163,184,.33);
            border-radius: 999px;
            color: #e2e8f0;
            padding: 5px 12px 6px;
            font-size: .8rem;
            cursor: pointer;
        }

        .cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 14px;
        }
        .card {
            background: var(--card);
            border: 1px solid rgba(255,255,255,.02);
            border-radius: 16px;
            padding: 14px 14px 13px;
            backdrop-filter: blur(10px);
        }
        .card-title { font-size: .9rem; color: #cbd5f5; display: flex; justify-content: space-between; }
        .card-value { font-size: 1.6rem; font-weight: 700; margin-top: 6px; }
        .card-hint { font-size: .75rem; color: #94a3b8; margin-top: 5px; }

        .users-card {
            background: var(--card);
            border: 1px solid rgba(255,255,255,.02);
            border-radius: 16px;
            padding: 14px 14px 10px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: .8rem;
        }
        th, td {
            text-align: left;
            padding: 8px 4px;
            vertical-align: middle;
        }
        th {
            color: #94a3b8;
            font-weight: 500;
            border-bottom: 1px solid rgba(255,255,255,.02);
            font-size: .75rem;
        }
        tr + tr td { border-top: 1px solid rgba(255,255,255,.018); }
        .badge {
            display: inline-flex;
            align-items: center;
            gap: 3px;
            background: rgba(15,118,110,.12);
            border: 1px solid rgba(34,197,235,.15);
            border-radius: 999px;
            padding: 3px 10px 4px;
            font-size: .7rem;
        }
        .badge-admin {
            background: rgba(248,113,113,.14);
            border: 1px solid rgba(248,113,113,.35);
        }
        .actions-cell {
            display: flex;
            gap: 6px;
        }
        .table-btn {
            border: none;
            border-radius: 10px;
            padding: 5px 11px 6px;
            font-size: .72rem;
            cursor: pointer;
        }
        .table-btn.edit {
            background: rgba(56,189,248,.14);
            color: #e2e8f0;
        }
        .table-btn.delete {
            background: rgba(244,63,94,.15);
            color: #fecdd3;
        }

        .modal-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(2,6,23,.58);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 200;
        }
        .modal {
            background: rgba(15,23,42,.97);
            color: #e2e8f0;
            width: min(520px, 95vw);
            border-radius: 18px;
            border: 1px solid rgba(148,163,184,.12);
            padding: 20px 22px 18px;
            box-shadow: 0 24px 55px rgba(0,0,0,.35);
        }
        .modal-title { font-size: 1.05rem; font-weight: 600; margin-bottom: 6px; }
        .modal-sub { font-size: .77rem; color: #94a3b8; margin-bottom: 14px; }
        .form-group { margin-bottom: 11px; }
        .form-label { font-size: .74rem; margin-bottom: 4px; display: block; }
        .form-input, .form-select {
            width: 100%;
            background: rgba(15,23,42,.4);
            border: 1px solid rgba(148,163,184,.35);
            border-radius: 12px;
            padding: 8px 11px;
            font-size: .82rem;
            outline: none;
            color: #e2e8f0;
        }
        .form-input:focus, .form-select:focus {
            border-color: rgba(56,189,248,.7);
            background: rgba(15,23,42,.7);
        }
        .modal-actions { display: flex; justify-content: flex-end; gap: 8px; margin-top: 8px; }

        .toast {
            position: fixed;
            top: 18px;
            right: 20px;
            background: rgba(22,163,74,.9);
            color: #fff;
            padding: 10px 13px;
            border-radius: 12px;
            font-size: .78rem;
            display: none;
            z-index: 300;
            box-shadow: 0 12px 25px rgba(0,0,0,.3);
        }

        @media (max-width: 950px) {
            .main { flex-direction: column; }
            .sidebar { width: 100%; display: flex; gap: 16px; overflow-x: auto; }
        }
    </style>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body>
<div class="topbar">
    <div class="brand">HR Turnover ‚Ä¢ –ø–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</div>
    <div>
        <span sec:authentication="name" style="font-size:.78rem;margin-right:8px;"></span>
        <a th:href="@{/logout}" style="color:#f97316; text-decoration:none; font-size:.78rem;">–í—ã–π—Ç–∏</a>
    </div>
</div>

<div class="main">
    <aside class="sidebar">
        <div class="sidebar-title">–ù–∞–≤–∏–≥–∞—Ü–∏—è</div>
        <div class="menu">
            <a href="/admin/dashboard" class="active">–ü–∞–Ω–µ–ª—å</a>
            <a href="/users">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</a>
            <a href="/dict/ping">–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–æ–≤</a>
            <a href="/hr-events">–ö–∞–¥—Ä–æ–≤—ã–µ —Å–æ–±—ã—Ç–∏—è</a>
            <a href="/metrics">–ü–æ–∫–∞–∑–∞—Ç–µ–ª–∏</a>
        </div>
        <div class="sidebar-title">–†–æ–ª–∏</div>
        <div class="menu">
            <a th:href="@{/user/dashboard}">–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∫–∞–∫ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫</a>
        </div>
    </aside>

    <main class="content">
        <div class="title-row">
            <div>
                <h1>–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ üëã</h1>
                <p class="subtitle">–°–æ–∑–¥–∞–≤–∞–π—Ç–µ –ª—é–¥–µ–π, –º–µ–Ω—è–π—Ç–µ —Ä–æ–ª–∏, —É–¥–∞–ª—è–π—Ç–µ –ª–∏—à–Ω–µ–µ ‚Äî –≤ –æ–¥–∏–Ω –∫–ª–∏–∫.</p>
            </div>
            <div>
                <button id="btnOpenCreate" class="btn-primary">–ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</button>
            </div>
        </div>

        <div class="cards">
            <div class="card">
                <div class="card-title">–í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div>
                <div class="card-value" id="statUsers">‚Äî</div>
                <div class="card-hint">–∞–∫—Ç–∏–≤–Ω—ã–µ –∏ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ</div>
            </div>
            <div class="card">
                <div class="card-title">–ö–∞–¥—Ä–æ–≤—ã–µ —Å–æ–±—ã—Ç–∏—è</div>
                <div class="card-value" id="statEvents">‚Äî</div>
                <div class="card-hint">–≤—Å–µ –∑–∞–ø–∏—Å–∏</div>
            </div>
            <div class="card">
                <div class="card-title">–¢–µ–∫—É—á–µ—Å—Ç—å (–º–µ—Å)</div>
                <div class="card-value" id="statTurnover">‚Äî</div>
                <div class="card-hint">–ø–æ —Ç–µ–∫—É—â–µ–º—É –º–µ—Å—è—Ü—É</div>
            </div>
        </div>

        <div style="display:flex; gap:16px; flex-wrap:wrap;">
            <div class="users-card" style="flex:1 1 360px; min-width: 360px;">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
                    <span style="font-size:1rem;font-weight:600;">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</span>
                    <button class="btn-secondary" id="btnOpenCreate2">–î–æ–±–∞–≤–∏—Ç—å</button>
                </div>
                <table id="usersTable">
                    <thead>
                    <tr>
                        <th>–§–ò–û</th>
                        <th>–õ–æ–≥–∏–Ω</th>
                        <th>–†–æ–ª—å</th>
                        <th>–°—Ç–∞—Ç—É—Å</th>
                        <th style="width:140px;">–î–µ–π—Å—Ç–≤–∏—è</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr><td colspan="5" style="padding-top:8px;">–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr>
                    </tbody>
                </table>
            </div>

            <div class="users-card" style="margin:auto; max-width: 520px; width:100%;">
                <div style="text-align:center; font-weight:600; margin-bottom:4px;">–£–≤–æ–ª—å–Ω–µ–Ω–∏—è –ø–æ –º–µ—Å—è—Ü–∞–º</div>
                <canvas id="turnoverChart" height="130"></canvas>
            </div>
        </div>
    </main>
</div>

<div class="modal-backdrop" id="createModal">
    <div class="modal">
        <div class="modal-title">–ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</div>
        <div class="modal-sub">–ó–∞–ø–æ–ª–Ω–∏—Ç–µ ‚Äî –∏ —á–µ–ª–æ–≤–µ–∫ —Å–º–æ–∂–µ—Ç –≤–æ–π—Ç–∏.</div>

        <div class="form-group">
            <label class="form-label" for="cFullName">–§–ò–û</label>
            <input id="cFullName" class="form-input" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω" />
        </div>
        <div class="form-group">
            <label class="form-label" for="cUsername">–õ–æ–≥–∏–Ω</label>
            <input id="cUsername" class="form-input" placeholder="login" />
        </div>
        <div class="form-group">
            <label class="form-label" for="cPassword">–ü–∞—Ä–æ–ª—å</label>
            <input id="cPassword" type="password" class="form-input" placeholder="–Ω–µ –º–µ–Ω–µ–µ 6 —Å–∏–º–≤–æ–ª–æ–≤" />
        </div>
        <div class="form-group">
            <label class="form-label" for="cConfirm">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–∞—Ä–æ–ª—è</label>
            <input id="cConfirm" type="password" class="form-input" placeholder="–ø–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–∞—Ä–æ–ª—å" />
        </div>
        <div class="form-group">
            <label class="form-label" for="cRole">–ü—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞</label>
            <select id="cRole" class="form-select">
                <option value="USER">–û–±—ã—á–Ω—ã–π –¥–æ—Å—Ç—É–ø</option>
                <option value="ADMIN">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</option>
            </select>
        </div>
        <div class="modal-actions">
            <button class="btn-secondary" data-close-create>–û—Ç–º–µ–Ω–∞</button>
            <button class="btn-primary" id="btnCreateUser">–°–æ–∑–¥–∞—Ç—å</button>
        </div>
    </div>
</div>

<div class="modal-backdrop" id="editModal">
    <div class="modal">
        <div class="modal-title">–ò–∑–º–µ–Ω–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</div>
        <div class="modal-sub">–ú–æ–∂–µ—Ç–µ –ø–æ–ø—Ä–∞–≤–∏—Ç—å –§–ò–û, –ª–æ–≥–∏–Ω, —Ä–æ–ª—å –∏ –ø–∞—Ä–æ–ª—å.</div>

        <input type="hidden" id="eId"/>

        <div class="form-group">
            <label class="form-label" for="eFullName">–§–ò–û</label>
            <input id="eFullName" class="form-input"/>
        </div>
        <div class="form-group">
            <label class="form-label" for="eUsername">–õ–æ–≥–∏–Ω</label>
            <input id="eUsername" class="form-input"/>
        </div>
        <div class="form-group">
            <label class="form-label" for="eRole">–ü—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞</label>
            <select id="eRole" class="form-select">
                <option value="USER">–û–±—ã—á–Ω—ã–π –¥–æ—Å—Ç—É–ø</option>
                <option value="ADMIN">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</option>
            </select>
        </div>
        <div class="form-group">
            <label class="form-label" for="ePassword">–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)</label>
            <input id="ePassword" type="password" class="form-input" placeholder="–æ—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º ‚Äî –Ω–µ –∏–∑–º–µ–Ω–∏—Ç—Å—è"/>
        </div>
        <div class="form-group">
            <label class="form-label" for="eConfirm">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–∞—Ä–æ–ª—è</label>
            <input id="eConfirm" type="password" class="form-input"/>
        </div>
        <div class="modal-actions">
            <button class="btn-secondary" data-close-edit>–û—Ç–º–µ–Ω–∞</button>
            <button class="btn-primary" id="btnUpdateUser">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
    </div>
</div>

<div class="toast" id="toast">–ì–æ—Ç–æ–≤–æ ‚úÖ</div>

<script>
    const createModal = document.getElementById('createModal');
    const editModal = document.getElementById('editModal');
    const toast = document.getElementById('toast');

    function openCreate() { createModal.style.display = 'flex'; }
    function closeCreate() { createModal.style.display = 'none'; }
    function openEdit() { editModal.style.display = 'flex'; }
    function closeEdit() { editModal.style.display = 'none'; }

    document.getElementById('btnOpenCreate').addEventListener('click', openCreate);
    document.getElementById('btnOpenCreate2').addEventListener('click', openCreate);
    createModal.addEventListener('click', e => { if (e.target === createModal) closeCreate(); });
    editModal.addEventListener('click', e => { if (e.target === editModal) closeEdit(); });
    document.querySelector('[data-close-create]').addEventListener('click', closeCreate);
    document.querySelector('[data-close-edit]').addEventListener('click', closeEdit);

    function showToast(msg) {
        toast.textContent = msg;
        toast.style.display = 'block';
        setTimeout(() => toast.style.display = 'none', 2500);
    }

    function loadUsers() {
        fetch('/api/users', { credentials: 'same-origin' })
            .then(r => r.json())
            .then(list => {
                const tbody = document.querySelector('#usersTable tbody');
                tbody.innerHTML = '';
                list.forEach(u => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${u.fullName || '‚Äî'}</td>
                        <td>${u.username}</td>
                        <td>
                            <span class="badge ${u.role === 'ADMIN' ? 'badge-admin' : ''}">
                                ${u.role === 'ADMIN' ? '–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä' : '—Å–æ—Ç—Ä—É–¥–Ω–∏–∫'}
                            </span>
                        </td>
                        <td>${(u.enabled === 1 || u.enabled === true) && (u.active === 1 || u.active === true) ? '–∞–∫—Ç–∏–≤–µ–Ω' : '–∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω'}</td>
                        <td>
                            <div class="actions-cell">
                                <button class="table-btn edit"
                                    data-edit='${JSON.stringify(u).replace(/'/g, "&apos;")}'>
                                    –ò–∑–º–µ–Ω–∏—Ç—å
                                </button>
                                <button class="table-btn delete" data-del="${u.id}">
                                    –£–¥–∞–ª–∏—Ç—å
                                </button>
                            </div>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
                document.getElementById('statUsers').textContent = list.length;

                document.querySelectorAll('[data-edit]').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const u = JSON.parse(btn.getAttribute('data-edit'));
                        document.getElementById('eId').value = u.id;
                        document.getElementById('eFullName').value = u.fullName || '';
                        document.getElementById('eUsername').value = u.username || '';
                        document.getElementById('eRole').value = u.role || 'USER';
                        document.getElementById('ePassword').value = '';
                        document.getElementById('eConfirm').value = '';
                        openEdit();
                    });
                });

                document.querySelectorAll('[data-del]').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const id = btn.getAttribute('data-del');
                        if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è?')) return;
                        const formData = new URLSearchParams();
                        formData.append('id', id);
                        fetch('/admin/users/delete', {
                            method: 'POST',
                            credentials: 'same-origin',
                            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                            body: formData.toString()
                        })
                            .then(() => {
                                showToast('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–¥–∞–ª—ë–Ω');
                                loadUsers();
                            })
                            .catch(() => showToast('–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å'));
                    });
                });
            })
            .catch(() => {
                const tbody = document.querySelector('#usersTable tbody');
                tbody.innerHTML = '<tr><td colspan="5">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</td></tr>';
            });
    }

    document.getElementById('btnCreateUser').addEventListener('click', () => {
        const fullName = document.getElementById('cFullName').value.trim();
        const username = document.getElementById('cUsername').value.trim();
        const password = document.getElementById('cPassword').value.trim();
        const confirm = document.getElementById('cConfirm').value.trim();
        const role = document.getElementById('cRole').value;

        if (!username || !password) {
            alert('–£–∫–∞–∂–∏—Ç–µ –ª–æ–≥–∏–Ω –∏ –ø–∞—Ä–æ–ª—å');
            return;
        }

        const formData = new URLSearchParams();
        formData.append('username', username);
        formData.append('fullName', fullName || username);
        formData.append('password', password);
        formData.append('confirmPassword', confirm);
        formData.append('role', role);

        fetch('/admin/users/create', {
            method: 'POST',
            credentials: 'same-origin',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: formData.toString()
        })
            .then(r => {
                if (!r.ok) throw new Error();
                closeCreate();
                showToast('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–∑–¥–∞–Ω ‚úÖ');
                loadUsers();
            })
            .catch(() => showToast('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è'));
    });

    document.getElementById('btnUpdateUser').addEventListener('click', () => {
        const id = document.getElementById('eId').value;
        const fullName = document.getElementById('eFullName').value.trim();
        const username = document.getElementById('eUsername').value.trim();
        const role = document.getElementById('eRole').value;
        const password = document.getElementById('ePassword').value.trim();
        const confirm = document.getElementById('eConfirm').value.trim();

        const formData = new URLSearchParams();
        formData.append('id', id);
        formData.append('username', username);
        formData.append('fullName', fullName);
        formData.append('role', role);
        formData.append('enabled', '1');
        formData.append('active', '1');
        if (password) {
            formData.append('password', password);
            formData.append('confirmPassword', confirm);
        }

        fetch('/admin/users/update', {
            method: 'POST',
            credentials: 'same-origin',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: formData.toString()
        })
            .then(r => {
                if (!r.ok) throw new Error();
                closeEdit();
                showToast('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ–±–Ω–æ–≤–ª—ë–Ω ‚úÖ');
                loadUsers();
            })
            .catch(() => showToast('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å'));
    });

    function loadStats() {
        fetch('/api/hr-events', { credentials: 'same-origin' })
            .then(r => r.json())
            .then(data => {
                document.getElementById('statEvents').textContent = data.length;
                const byMonth = {};
                data.forEach(ev => {
                    if (ev.eventType !== 'TERMINATION') return;
                    if (!ev.eventDate) return;
                    const ym = ev.eventDate.slice(0, 7);
                    byMonth[ym] = (byMonth[ym] || 0) + 1;
                });
                const labels = Object.keys(byMonth).sort();
                const values = labels.map(l => byMonth[l]);
                const ctx = document.getElementById('turnoverChart').getContext('2d');
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: '–£–≤–æ–ª—å–Ω–µ–Ω–∏—è',
                            data: values,
                            tension: 0.35,
                            borderColor: '#38bdf8',
                            backgroundColor: 'rgba(56, 189, 248, .15)',
                            borderWidth: 2,
                            pointRadius: 4,
                            pointBackgroundColor: '#38bdf8'
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: { legend: { display: false } },
                        scales: {
                            x: { ticks: { color: '#94a3b8' } },
                            y: { beginAtZero: true, ticks: { color: '#94a3b8', stepSize: 1 } }
                        }
                    }
                });
            });

        fetch('/api/metrics/current', { credentials: 'same-origin' })
            .then(r => r.json())
            .then(m => {
                const el = document.getElementById('statTurnover');
                if (m && typeof m.turnoverMonth !== 'undefined') {
                    el.textContent = m.turnoverMonth + '%';
                } else {
                    el.textContent = '‚Äî';
                }
            })
            .catch(() => {
                document.getElementById('statTurnover').textContent = '‚Äî';
            });
    }

    loadUsers();
    loadStats();
</script>
</body>
</html>



